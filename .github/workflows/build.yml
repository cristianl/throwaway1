name: Probe1

on: [push, workflow_dispatch]

env:
  MACOSX_DEPLOYMENT_TARGET: "10.13"
  node_version: "22.7.0"

jobs:
  build:
    runs-on: ${{ matrix.os }}

    strategy:
      matrix:
        os: [macOS-13]
        include:
          - os: macOS-13

    # try to use clang-14 built for hs - if that fails, try to at least have the libs as built for hs
    steps:
      - name: Install MacPorts and clang
        run:
          export _clang_pkg=clang-14-14.0.6_2+analyzer.darwin_17.x86_64
          
          aria2c "https://packages.macports.org/clang-14/$_clang_pkg.tbz2"

          mkdir -p $_clang_pkg && cd $_clang_pkg

          tar -xf ../$_clang_pkg.tbz2

          aria2c "https://github.com/macports/macports-base/releases/download/v2.10.1/MacPorts-2.10.1-13-Ventura.pkg"
          
          sudo installer -pkg MacPorts-2.10.1-13-Ventura.pkg -target /

          export PATH="/opt/local/bin:/opt/local/sbin:$PATH"

          sudo port install clang-14

          sudo rsync -av --ignore-times clang-14-14.0.6_2+analyzer.darwin_17.x86_64/ /

          sudo sed -i -e 's/11.1.0/14.0.6/' -e 's/11/14/' -e '/patch -p0/d' /opt/local/var/macports/sources/rsync.macports.org/macports/release/tarballs/ports/lang/macports-libcxx/Portfile

          awk -v n=1 -v s='#define _LIBCPP_DISABLE_AVAILABILITY' 'NR == n {print s} {print}' /opt/local/libexec/llvm-14/include/c++/v1/__config > __config.tmp

          sudo mv -f __config.tmp /opt/local/libexec/llvm-14/include/c++/v1/__config

          sudo port destroot macports-libcxx

          sudo port install macports-libcxx
          
          sudo port select --set clang mp-clang-14

          curl -L --compressed "https://github.com/llvm/llvm-project/raw/release/14.x/libcxxabi/include/cxxabi.h" -o cxxabi.h

          curl -L --compressed "https://github.com/llvm/llvm-project/raw/release/14.x/libcxxabi/include/__cxxabi_config.h" -o __cxxabi_config.h

          sudo mv -f cxxabi.h /opt/local/include/libcxx/v1/cxxabi.h

          sudo mv -f __cxxabi_config.h /opt/local/include/libcxx/v1/__cxxabi_config.h

          rm -f MacPorts-2.10.1-13-Ventura.pkg $_clang_pkg.tbz2

      - name: Get source and build
        run:
          initial=$(pwd)

          curl -L "https://github.com/nodejs/node/archive/refs/tags/v${{ env.node_version }}.tar.gz" | tar -x

          cd "node-${{ env.node_version }}"

          sed -i '' "s/'11.0'/'${{ env.MACOSX_DEPLOYMENT_TARGET }}'/" common.gypi

          export PATH="/opt/local/bin:/opt/local/sbin:$PATH"

          export CPPFLAGS="-nostdinc++ -isystem/opt/local/include/libcxx/v1 -D_LIBCPP_DISABLE_AVAILABILITY"

          export LDFLAGS="-nostdlib++ -L/opt/local/lib/libcxx -Wl,-rpath,/opt/local/lib/libcxx -lc++"

          ./configure

          make -j4

          rm -r out/Release/obj.target

          rm out/Release/libv8_base_without_compiler.a; rm out/Release/libv8_initializers.a; rm out/Release/libv8_compiler.a; rm out/Release/libnode.a; rm out/Release/libv8_turboshaft.a

          tar -c --zstd -f $initial/node.tar.zst out/Release

      - name: Upload SDK artifact
        uses: actions/upload-artifact@v4
        with:
          name: node-${{ env.node_version }}
          path: node.tar.zst
